<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GMP-ArchiveSys | Shared Cloud</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    
    <style>
        body { font-family: 'Inter', system-ui, -apple-system, sans-serif; }
        .glass-panel { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); }
        .required::after { content: " *"; color: red; }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        .toast { animation: slideIn 0.3s ease-out forwards; }
        
        /* Loading Overlay */
        #loading-overlay {
            position: fixed; inset: 0; background: rgba(255,255,255,0.98); 
            z-index: 100; display: flex; flex-direction: column; 
            align-items: center; justify-content: center;
            transition: opacity 0.5s ease-out;
        }
        #loading-overlay.fade-out {
            opacity: 0;
            pointer-events: none;
        }
        
        /* Status Indicator Pulse */
        @keyframes pulse-green {
            0% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7); }
            70% { box-shadow: 0 0 0 6px rgba(34, 197, 94, 0); }
            100% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0); }
        }
        .status-live {
            animation: pulse-green 2s infinite;
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 h-screen flex flex-col overflow-hidden">
    <!-- Loading Screen -->
    <div id="loading-overlay">
        <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-blue-600 mb-4"></div>
        <h2 class="text-xl font-bold text-slate-700">Connessione al Database Condiviso...</h2>
        <p class="text-slate-500 text-sm mt-2" id="loading-text">Inizializzazione...</p>
        
        <div id="config-error-msg" class="hidden mt-6 p-4 bg-red-50 text-red-700 border border-red-200 rounded text-xs max-w-md text-center">
            <i class="fas fa-exclamation-triangle text-xl mb-2"></i><br>
            <strong>Problema di Configurazione Rilevato:</strong> <span id="config-error-detail"></span><br><br>
            <ul class="text-left list-disc ml-4 space-y-1">
                <li>Assicurati di aver incollato la tua <code>firebaseConfig</code> nel codice.</li>
                <li>Controlla di aver impostato le <strong>Regole Firestore</strong> su <code>allow read, write: if true;</code>.</li>
                <li>Verifica che l'Autenticazione "Anonima" sia abilitata.</li>
            </ul>
        </div>

        <button onclick="app.checkCompletion(true)" class="mt-8 text-xs text-slate-400 underline hover:text-slate-600 cursor-pointer z-50">
            Forza avvio (se bloccato)
        </button>
    </div>

    <!-- ================= LOGIN SCREEN ================= -->
    <div id="login-screen" class="fixed inset-0 z-50 bg-slate-200 flex items-center justify-center hidden">
        <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-md border-t-4 border-blue-600 relative overflow-hidden">
            <!-- Badge Environment -->
            <div class="absolute top-0 right-0 bg-green-500 text-white text-[10px] px-3 py-1 rounded-bl-lg font-bold uppercase tracking-wider">
                Live Environment
            </div>

            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold text-blue-800">GMP-ArchiveSys</h1>
                <div class="flex items-center justify-center gap-2 mt-3 text-sm text-slate-600 bg-slate-100 py-1.5 px-4 rounded-full w-fit mx-auto border border-slate-200">
                    <div class="w-2.5 h-2.5 bg-green-500 rounded-full status-live"></div>
                    Cloud DB: <span class="font-mono font-bold text-slate-800">gmp_v2/public</span>
                </div>
                <p class="text-slate-400 text-xs mt-2 max-w-xs mx-auto">
                    Tutti i dati inseriti qui sono visibili in tempo reale a chiunque acceda a questo link.
                </p>
            </div>
            
            <form id="login-form" class="space-y-6">
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">ID Utente</label>
                    <div class="relative">
                        <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-slate-400"><i class="fas fa-user"></i></span>
                        <input type="text" id="login-username" class="w-full pl-10 p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition" placeholder="Es. ADMIN" required>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Password</label>
                    <div class="relative">
                        <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-slate-400"><i class="fas fa-lock"></i></span>
                        <input type="password" id="login-password" class="w-full pl-10 p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition" placeholder="********" required>
                    </div>
                </div>
                <button type="submit" class="w-full bg-blue-700 hover:bg-blue-800 text-white font-bold py-3 rounded-lg shadow-md transition transform active:scale-95">
                    ACCEDI AL SISTEMA
                </button>
            </form>
            
            <div class="mt-6 p-4 bg-blue-50 rounded text-xs text-blue-800">
                <p class="font-bold mb-1">Credenziali Default (Seeding):</p>
                <ul class="list-disc ml-4 space-y-1">
                    <li>Admin: <code>ADMIN</code> / <code>password123</code></li>
                    <li>Supervisore: <code>SUP</code> / <code>password123</code></li>
                </ul>
            </div>
        </div>
    </div>

    <!-- ================= MAIN APP LAYOUT ================= -->
    <div id="app-layout" class="flex h-screen hidden">
        <!-- Sidebar -->
        <aside class="w-64 bg-slate-900 text-white flex flex-col shadow-xl z-20">
            <div class="p-6 border-b border-slate-700">
                <div class="text-xl font-bold tracking-tight">GMP-ArchiveSys</div>
                <div class="text-xs text-slate-400 mt-1 flex items-center gap-2">
                    <div class="w-2 h-2 rounded-full bg-green-500 status-live"></div> Connesso e Sincronizzato
                </div>
            </div>
            <nav class="flex-1 py-6 space-y-1 px-3">
                <button onclick="app.nav('dashboard')" class="nav-btn w-full text-left px-4 py-3 rounded-lg hover:bg-slate-800 transition flex items-center gap-3 text-slate-300 hover:text-white">
                    <i class="fas fa-chart-line w-5"></i> Dashboard
                </button>
                <button onclick="app.nav('archive')" class="nav-btn w-full text-left px-4 py-3 rounded-lg hover:bg-slate-800 transition flex items-center gap-3 text-slate-300 hover:text-white">
                    <i class="fas fa-box-archive w-5"></i> Archivio Fisico
                </button>
                <button onclick="app.nav('batch-records')" class="nav-btn w-full text-left px-4 py-3 rounded-lg hover:bg-slate-800 transition flex items-center gap-3 text-slate-300 hover:text-white">
                    <i class="fas fa-file-medical w-5"></i> Batch Records
                </button>
                <button onclick="app.nav('loans')" class="nav-btn w-full text-left px-4 py-3 rounded-lg hover:bg-slate-800 transition flex items-center gap-3 text-slate-300 hover:text-white">
                    <i class="fas fa-hand-holding w-5"></i> Prestiti <span id="badge-loans" class="hidden bg-red-500 text-white text-xs px-2 py-0.5 rounded-full ml-auto">0</span>
                </button>
                <div class="border-t border-slate-700 my-2"></div>
                <button id="nav-products" onclick="app.nav('products')" class="nav-btn w-full text-left px-4 py-3 rounded-lg hover:bg-slate-800 transition flex items-center gap-3 text-slate-300 hover:text-white hidden restricted-nav" data-roles="Supervisore,Amministratore">
                    <i class="fas fa-boxes w-5"></i> Anagrafica Prodotti
                </button>
                <button id="nav-security" onclick="app.nav('security')" class="nav-btn w-full text-left px-4 py-3 rounded-lg hover:bg-slate-800 transition flex items-center gap-3 text-slate-300 hover:text-white hidden restricted-nav" data-roles="Amministratore">
                    <i class="fas fa-shield-alt w-5"></i> Sicurezza & Policy
                </button>
                <button id="nav-users" onclick="app.nav('users')" class="nav-btn w-full text-left px-4 py-3 rounded-lg hover:bg-slate-800 transition flex items-center gap-3 text-slate-300 hover:text-white hidden">
                    <i class="fas fa-users-cog w-5"></i> Gestione Utenti
                </button>
                <button id="nav-audit" onclick="app.nav('audit')" class="nav-btn w-full text-left px-4 py-3 rounded-lg hover:bg-slate-800 transition flex items-center gap-3 text-slate-300 hover:text-white hidden">
                    <i class="fas fa-clipboard-list w-5"></i> Audit Trail
                </button>
            </nav>
            <div class="p-4 bg-slate-800 border-t border-slate-700">
                <div class="flex items-center gap-3 mb-3">
                    <div class="w-10 h-10 rounded-full bg-blue-600 flex items-center justify-center font-bold text-lg" id="user-avatar">U</div>
                    <div class="overflow-hidden">
                        <div class="text-sm font-bold truncate" id="user-name">User Name</div>
                        <div class="text-xs text-slate-400 truncate" id="user-role">Role</div>
                    </div>
                </div>
                <button onclick="app.logout()" class="w-full bg-red-600/20 hover:bg-red-600 text-red-200 hover:text-white text-sm py-2 rounded border border-red-600/30 transition">
                    <i class="fas fa-sign-out-alt mr-2"></i> Logout
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 bg-slate-100 overflow-hidden flex flex-col relative">
            <!-- Header -->
            <header class="bg-white h-16 shadow-sm flex items-center justify-between px-8 z-10">
                <h2 id="page-title" class="text-xl font-bold text-slate-800">Dashboard</h2>
                <div class="text-sm text-slate-500">
                    GMP-ArchiveSys Cloud | <span id="system-time"></span>
                </div>
            </header>

            <!-- Views Container -->
            <div id="views-container" class="flex-1 overflow-y-auto p-8 relative">
                
                <!-- DASHBOARD -->
                <div id="view-dashboard" class="view-section space-y-6">
                     <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                        <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-blue-500">
                            <div class="text-slate-500 text-sm font-medium uppercase">Batch Record Totali</div>
                            <div class="text-3xl font-bold text-slate-800 mt-2" id="dash-total-br">0</div>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-green-500">
                            <div class="text-slate-500 text-sm font-medium uppercase">Archiviati</div>
                            <div class="text-3xl font-bold text-slate-800 mt-2" id="dash-archived-br">0</div>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-yellow-500">
                            <div class="text-slate-500 text-sm font-medium uppercase">In Prestito</div>
                            <div class="text-3xl font-bold text-slate-800 mt-2" id="dash-loaned-br">0</div>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-red-500">
                            <div class="text-slate-500 text-sm font-medium uppercase">Richieste Pendenti</div>
                            <div class="text-3xl font-bold text-slate-800 mt-2" id="dash-pending-loans">0</div>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="bg-white p-6 rounded-xl shadow-sm">
                            <h3 class="font-bold text-slate-800 mb-4">Stato Archiviazione</h3>
                            <div class="h-64 relative w-full flex justify-center"><canvas id="chart-status"></canvas></div>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-sm flex flex-col">
                            <h3 class="font-bold text-slate-800 mb-4">Accesso Rapido</h3>
                            <div class="grid grid-cols-2 gap-4 flex-1">
                                <button onclick="app.nav('batch-records', 'create')" class="bg-blue-50 hover:bg-blue-100 text-blue-700 p-4 rounded-lg border border-blue-200 flex flex-col items-center justify-center gap-2 transition restricted-btn" data-roles="Operatore,Supervisore,Amministratore"><i class="fas fa-plus-circle text-2xl"></i><span class="font-medium">Nuovo BR</span></button>
                                <button onclick="app.nav('loans')" class="bg-purple-50 hover:bg-purple-100 text-purple-700 p-4 rounded-lg border border-purple-200 flex flex-col items-center justify-center gap-2 transition"><i class="fas fa-search text-2xl"></i><span class="font-medium">Cerca & Richiedi</span></button>
                                <button onclick="app.nav('audit')" class="bg-gray-50 hover:bg-gray-100 text-gray-700 p-4 rounded-lg border border-gray-200 flex flex-col items-center justify-center gap-2 transition restricted-btn" data-roles="Supervisore,Amministratore"><i class="fas fa-history text-2xl"></i><span class="font-medium">Review Audit Log</span></button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- SECURITY SETTINGS (NEW) -->
                <div id="view-security" class="view-section hidden space-y-6">
                    <div class="bg-red-50 border border-red-200 p-4 rounded-lg mb-6">
                        <h3 class="text-red-800 font-bold flex items-center"><i class="fas fa-exclamation-triangle mr-2"></i> Area Critica CFR 21 Part 11</h3>
                        <p class="text-sm text-red-700 mt-1">Le modifiche in questa sezione alterano i criteri di sicurezza globali. Ogni modifica viene tracciata nell'Audit Trail.</p>
                    </div>
                    
                    <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                        <h3 class="text-xl font-bold text-slate-800 mb-6">Criteri Complessità Password</h3>
                        <form id="security-settings-form" class="space-y-6">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-1">Lunghezza Minima</label>
                                    <input type="number" name="minLength" id="sec-min-length" class="w-full p-2 border rounded" min="4" max="32">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-1">Scadenza Password (Giorni)</label>
                                    <input type="number" name="expiryDays" id="sec-expiry" class="w-full p-2 border rounded" min="0">
                                    <p class="text-xs text-slate-500 mt-1">0 = Nessuna scadenza</p>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-1">Max Tentativi Login</label>
                                    <input type="number" name="maxAttempts" id="sec-attempts" class="w-full p-2 border rounded" min="1" max="10">
                                </div>
                            </div>
                            <div class="space-y-3">
                                <label class="flex items-center space-x-2">
                                    <input type="checkbox" name="requireNumber" id="sec-req-num" class="rounded text-blue-600 focus:ring-blue-500">
                                    <span class="text-sm text-slate-700">Richiedi almeno un numero (0-9)</span>
                                </label>
                                <label class="flex items-center space-x-2">
                                    <input type="checkbox" name="requireSpecial" id="sec-req-spec" class="rounded text-blue-600 focus:ring-blue-500">
                                    <span class="text-sm text-slate-700">Richiedi caratteri speciali (!@#$...)</span>
                                </label>
                                <label class="flex items-center space-x-2">
                                    <input type="checkbox" name="requireUpper" id="sec-req-upper" class="rounded text-blue-600 focus:ring-blue-500">
                                    <span class="text-sm text-slate-700">Richiedi lettere maiuscole (A-Z)</span>
                                </label>
                            </div>
                            <div class="flex justify-end pt-4 border-t">
                                <button type="submit" class="bg-red-600 hover:bg-red-700 text-white px-6 py-2 rounded-lg shadow font-bold transition">
                                    <i class="fas fa-save mr-2"></i> Salva Policy di Sicurezza
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- ARCHIVE -->
                <div id="view-archive" class="view-section hidden">
                    <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden flex h-[calc(100vh-10rem)]">
                        <div class="w-1/3 border-r border-slate-200 bg-slate-50 flex flex-col">
                            <div class="p-4 border-b border-slate-200 font-bold text-slate-700 flex justify-between items-center">
                                Struttura Fisica
                                <button onclick="app.modals.addArchive.show()" class="text-xs bg-blue-600 text-white px-2 py-1 rounded hover:bg-blue-700 restricted-btn" data-roles="Amministratore"><i class="fas fa-plus"></i></button>
                            </div>
                            <div id="archive-tree" class="flex-1 overflow-y-auto p-2 space-y-1"></div>
                        </div>
                        <div class="w-2/3 p-6 bg-white flex flex-col" id="archive-content">
                            <div class="h-full flex flex-col items-center justify-center text-slate-400"><i class="fas fa-arrow-left text-4xl mb-4"></i><p>Seleziona un elemento dalla struttura.</p></div>
                        </div>
                    </div>
                </div>

                <!-- BATCH RECORDS -->
                <div id="view-batch-records" class="view-section hidden space-y-4">
                    <div class="flex justify-between items-center">
                        <div class="flex gap-2">
                            <input type="text" id="br-search" placeholder="Cerca WO, Lotto, ID..." class="border border-slate-300 rounded-lg px-4 py-2 w-64 focus:ring-2 focus:ring-blue-500 outline-none">
                            <select id="br-filter-status" class="border border-slate-300 rounded-lg px-4 py-2 bg-white">
                                <option value="all">Tutti gli Stati</option>
                                <option value="In Archiviazione">In Archiviazione</option>
                                <option value="Archiviato">Archiviato</option>
                                <option value="In Prestito">In Prestito</option>
                            </select>
                        </div>
                        <button onclick="app.modals.createBR.show()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg shadow-sm restricted-btn transition" data-roles="Operatore,Supervisore,Amministratore"><i class="fas fa-plus mr-2"></i> Crea Batch Record</button>
                    </div>
                    <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                        <table class="w-full text-left">
                            <thead class="bg-slate-50 border-b border-slate-200 text-xs uppercase text-slate-500 font-semibold">
                                <tr><th class="p-4">ID</th><th class="p-4">Work Order</th><th class="p-4">Prodotto</th><th class="p-4">Tipologia</th><th class="p-4">Stato</th><th class="p-4">Posizione</th><th class="p-4 text-right">Azioni</th></tr>
                            </thead>
                            <tbody id="br-table-body" class="divide-y divide-slate-100"></tbody>
                        </table>
                    </div>
                </div>

                <!-- PRODUCTS MASTER DATA -->
                <div id="view-products" class="view-section hidden space-y-4">
                    <div class="flex justify-between items-center">
                        <h3 class="font-bold text-lg text-slate-700">Anagrafica Prodotti</h3>
                        <button onclick="document.getElementById('modal-create-product').classList.remove('hidden')" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg shadow-sm transition"><i class="fas fa-plus mr-2"></i> Nuovo Prodotto</button>
                    </div>
                    <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                        <table class="w-full text-left">
                            <thead class="bg-slate-50 border-b border-slate-200 text-xs uppercase text-slate-500 font-semibold">
                                <tr><th class="p-4">Codice Prodotto</th><th class="p-4">Nome Prodotto</th><th class="p-4">Descrizione</th><th class="p-4 text-right">Azioni</th></tr>
                            </thead>
                            <tbody id="products-table-body" class="divide-y divide-slate-100"></tbody>
                        </table>
                    </div>
                </div>

                <!-- LOANS -->
                <div id="view-loans" class="view-section hidden space-y-6">
                    <div id="loan-approvals-panel" class="hidden bg-yellow-50 border border-yellow-200 rounded-xl p-6">
                        <h3 class="font-bold text-yellow-800 mb-4 flex items-center gap-2"><i class="fas fa-clipboard-check"></i> Richieste Pendenti (Da Approvare)</h3>
                        <div id="loans-pending-list" class="space-y-3"></div>
                    </div>
                    <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                        <h3 class="font-bold text-slate-800 mb-4">Prestiti Attivi & Storico</h3>
                        <table class="w-full text-left text-sm">
                            <thead class="bg-slate-50 border-b border-slate-200"><tr><th class="p-3">Batch Record</th><th class="p-3">Richiedente</th><th class="p-3">Data Uscita</th><th class="p-3">Approvato da</th><th class="p-3">Stato</th><th class="p-3 text-right">Azioni</th></tr></thead>
                            <tbody id="loans-active-body" class="divide-y divide-slate-100"></tbody>
                        </table>
                    </div>
                </div>

                <!-- AUDIT TRAIL -->
                <div id="view-audit" class="view-section hidden">
                    <div class="bg-white rounded-xl shadow-sm border border-slate-200 flex flex-col h-[calc(100vh-10rem)]">
                        <div class="p-4 border-b border-slate-200 bg-slate-50 font-bold text-slate-700">Secure Audit Log</div>
                        <div class="flex-1 overflow-y-auto">
                            <table class="w-full text-left text-xs font-mono">
                                <thead class="bg-slate-100 sticky top-0"><tr><th class="p-2 border-b">Timestamp</th><th class="p-2 border-b">User</th><th class="p-2 border-b">Action</th><th class="p-2 border-b">Target</th><th class="p-2 border-b">Details</th></tr></thead>
                                <tbody id="audit-table-body" class="divide-y divide-slate-100"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- USERS -->
                <div id="view-users" class="view-section hidden space-y-4">
                    <div class="flex justify-end"><button onclick="app.modals.createUser.show()" class="bg-blue-600 text-white px-4 py-2 rounded-lg"><i class="fas fa-user-plus mr-2"></i> Crea Utente</button></div>
                    <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                        <table class="w-full text-left">
                            <thead class="bg-slate-50 border-b border-slate-200 text-xs uppercase text-slate-500 font-semibold"><tr><th class="p-4">ID</th><th class="p-4">Nome</th><th class="p-4">Ruolo</th><th class="p-4">Stato</th><th class="p-4">Azioni</th></tr></thead>
                            <tbody id="users-table-body" class="divide-y divide-slate-100"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modals -->
    
    <!-- MODAL FORCE PASSWORD CHANGE -->
    <div id="modal-force-password-change" class="hidden fixed inset-0 z-[60] flex items-center justify-center bg-slate-900/90 backdrop-blur-md">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md p-8 border-t-4 border-orange-500">
            <div class="text-center mb-6">
                <div class="w-16 h-16 bg-orange-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-key text-orange-600 text-2xl"></i>
                </div>
                <h2 class="text-2xl font-bold text-slate-800">Cambio Password Obbligatorio</h2>
                <p class="text-sm text-slate-500 mt-2">È necessario modificare la password temporanea per accedere al sistema.</p>
            </div>
            
            <form id="force-change-form" class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-slate-600 uppercase mb-1">Nuova Password</label>
                    <input type="password" id="force-new-pass" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-orange-500 outline-none" placeholder="Nuova Password" required>
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-600 uppercase mb-1">Conferma Password</label>
                    <input type="password" id="force-confirm-pass" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-orange-500 outline-none" placeholder="Ripeti Password" required>
                </div>
                
                <div class="bg-slate-50 p-3 rounded text-xs text-slate-600 border mt-2">
                    <p class="font-bold mb-1">Requisiti minimi:</p>
                    <ul id="password-requirements-list" class="list-disc ml-4 space-y-1">
                        <li>Minimo <span id="req-len">8</span> caratteri</li>
                    </ul>
                </div>

                <button type="submit" class="w-full bg-orange-600 hover:bg-orange-700 text-white font-bold py-3 rounded-lg shadow-md mt-4 transition">
                    Aggiorna e Accedi
                </button>
                <div class="text-center mt-2">
                    <button type="button" onclick="app.logout()" class="text-xs text-slate-400 hover:text-slate-600 underline">Annulla e Logout</button>
                </div>
            </form>
        </div>
    </div>

    <div id="modal-esig" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-slate-900/50 backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm p-6 border-t-4 border-red-600">
            <h3 class="text-lg font-bold text-slate-800 text-center mb-4">Firma Elettronica Richiesta</h3>
            <p class="text-xs text-slate-500 mb-4 text-center">Inserire password e motivazione per confermare l'azione.</p>
            <form id="esig-form" class="space-y-4">
                <input type="hidden" id="esig-callback-id">
                <div>
                    <label class="text-xs font-bold text-slate-600">Utente</label>
                    <input type="text" id="esig-username" class="w-full p-2 border rounded bg-slate-100" readonly>
                </div>
                <div>
                    <label class="text-xs font-bold text-slate-600 required">Password</label>
                    <input type="password" id="esig-password" class="w-full p-2 border rounded" required placeholder="Password">
                </div>
                <div>
                    <label class="text-xs font-bold text-slate-600 required">Motivazione / Commento</label>
                    <textarea id="esig-comment" class="w-full p-2 border rounded text-sm" rows="2" required placeholder="Es. Approvazione verifica..."></textarea>
                </div>
                <div class="flex gap-2 pt-2"><button type="button" onclick="document.getElementById('modal-esig').classList.add('hidden')" class="flex-1 py-2 border rounded">Annulla</button><button type="submit" class="flex-1 py-2 bg-red-600 text-white rounded font-bold">FIRMA</button></div>
            </form>
        </div>
    </div>

    <!-- MODAL DUAL E-SIG (User + Supervisor) -->
    <div id="modal-dual-esig" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-slate-900/50 backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md p-6 border-t-4 border-purple-600">
            <h3 class="text-lg font-bold text-slate-800 text-center mb-2">Doppia Firma Richiesta</h3>
            <p class="text-xs text-slate-500 mb-4 text-center">Riconsegna BR: Richiesta firma Utente e Supervisore.</p>
            <form id="dual-esig-form" class="space-y-4">
                <!-- User 1 (Current) -->
                <div class="bg-slate-50 p-3 rounded border">
                    <div class="text-xs font-bold text-blue-800 mb-2">1. Firma Operatore (Tu)</div>
                    <input type="text" id="dual-user1" class="w-full p-2 border rounded bg-white mb-2 text-xs" readonly>
                    <input type="password" id="dual-pass1" class="w-full p-2 border rounded text-xs" required placeholder="La tua Password">
                </div>
                <!-- User 2 (Supervisor) -->
                <div class="bg-purple-50 p-3 rounded border">
                    <div class="text-xs font-bold text-purple-800 mb-2">2. Firma Supervisore</div>
                    <select id="dual-user2-select" class="w-full p-2 border rounded mb-2 text-xs" required>
                        <option value="">Seleziona Supervisore...</option>
                    </select>
                    <input type="password" id="dual-pass2" class="w-full p-2 border rounded text-xs" required placeholder="Password Supervisore">
                </div>
                <div>
                    <label class="text-xs font-bold text-slate-600 required">Commento Congiunto</label>
                    <textarea id="dual-comment" class="w-full p-2 border rounded text-sm" rows="2" required placeholder="Es. Verifica integrità BR post prestito..."></textarea>
                </div>
                <div class="flex gap-2 pt-2"><button type="button" onclick="document.getElementById('modal-dual-esig').classList.add('hidden')" class="flex-1 py-2 border rounded">Annulla</button><button type="submit" class="flex-1 py-2 bg-purple-600 text-white rounded font-bold">CONFERMA DOPPIA FIRMA</button></div>
            </form>
        </div>
    </div>

    <div id="modal-create-br" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/30 backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-xl w-full max-w-lg p-6">
            <h3 class="text-xl font-bold text-slate-800 mb-4">Nuovo Batch Record</h3>
            <form id="create-br-form" class="space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-sm font-medium required">Work Order</label><input type="text" name="wo" class="w-full p-2 border rounded" required></div>
                    <!-- BUG 1: RIMOSSO pattern="\d+" PER PERMETTERE INSERIMENTO TESTO -->
                    <div><label class="block text-sm font-medium required">Lotto (Solo Numeri)</label><input type="text" name="lot" class="w-full p-2 border rounded" required></div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium required">Prodotto</label>
                        <select name="product" id="create-br-product-select" class="w-full p-2 border rounded" required>
                            <option value="">Seleziona Prodotto...</option>
                        </select>
                    </div>
                    <div><label class="block text-sm font-medium">Tipologia</label><select name="type" class="w-full p-2 border rounded"><option value="standard">Standard</option><option value="validazione">Validazione</option></select></div>
                </div>
                <div><label class="block text-sm font-medium">Note</label><textarea name="notes" class="w-full p-2 border rounded" rows="2"></textarea></div>
                <div class="flex justify-end gap-2 mt-4"><button type="button" onclick="document.getElementById('modal-create-br').classList.add('hidden')" class="px-4 py-2 border rounded">Annulla</button><button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded">Crea</button></div>
            </form>
        </div>
    </div>

    <div id="modal-create-product" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/30 backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-xl w-full max-w-md p-6">
            <h3 class="text-xl font-bold text-slate-800 mb-4">Nuovo Prodotto</h3>
            <form id="create-product-form" class="space-y-4">
                <div><label class="block text-sm font-medium required">Codice Prodotto</label><input type="text" name="code" class="w-full p-2 border rounded uppercase" required></div>
                <div><label class="block text-sm font-medium required">Nome Prodotto</label><input type="text" name="name" class="w-full p-2 border rounded" required></div>
                <div><label class="block text-sm font-medium">Descrizione</label><textarea name="desc" class="w-full p-2 border rounded" rows="2"></textarea></div>
                <div class="flex justify-end gap-2 mt-4"><button type="button" onclick="document.getElementById('modal-create-product').classList.add('hidden')" class="px-4 py-2 border rounded">Annulla</button><button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded">Salva (Richiede Firma)</button></div>
            </form>
        </div>
    </div>

    <div id="modal-create-user" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/30 backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-xl w-full max-w-md p-6">
            <h3 class="text-xl font-bold text-slate-800 mb-4">Nuovo Utente</h3>
            <form id="create-user-form" class="space-y-4">
                <div><label class="block text-sm font-medium">ID Utente</label><input type="text" name="uid" class="w-full p-2 border rounded uppercase" required></div>
                <div><label class="block text-sm font-medium">Nome</label><input type="text" name="name" class="w-full p-2 border rounded" required></div>
                <div><label class="block text-sm font-medium">Ruolo</label><select name="role" class="w-full p-2 border rounded"><option value="Read Only">Read Only</option><option value="Operatore">Operatore</option><option value="Supervisore">Supervisore</option><option value="Amministratore">Amministratore</option></select></div>
                <div><label class="block text-sm font-medium">Password</label><input type="password" name="pass" class="w-full p-2 border rounded" value="password123" required></div>
                <div class="flex justify-end gap-2 mt-4"><button type="button" onclick="document.getElementById('modal-create-user').classList.add('hidden')" class="px-4 py-2 border rounded">Annulla</button><button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded">Salva</button></div>
            </form>
        </div>
    </div>
    <div id="modal-add-archive" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/30 backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-xl w-full max-w-md p-6">
            <h3 class="text-xl font-bold text-slate-800 mb-4">Aggiungi Elemento Archivio</h3>
            <form id="add-archive-form" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium">Tipo</label>
                    <select id="archive-type-select" name="type" class="w-full p-2 border rounded" onchange="app.updateParentSelect()">
                        <option value="archive">Archivio (Root)</option><option value="cupboard">Armadio</option><option value="shelf">Scaffale</option><option value="binder">Faldone</option>
                    </select>
                </div>
                <div id="parent-select-container" class="hidden"><label class="block text-sm font-medium">Padre</label><select id="archive-parent-select" name="parentId" class="w-full p-2 border rounded"></select></div>
                <div><label class="block text-sm font-medium">Nome/Codice</label><input type="text" name="name" class="w-full p-2 border rounded" required></div>
                <div class="flex justify-end gap-2 mt-4"><button type="button" onclick="document.getElementById('modal-add-archive').classList.add('hidden')" class="px-4 py-2 border rounded">Annulla</button><button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded">Aggiungi</button></div>
            </form>
        </div>
    </div>
    <div id="modal-archive-select" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/30 backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-xl w-full max-w-md p-6 h-[500px] flex flex-col">
            <h3 class="text-lg font-bold text-slate-800 mb-2">Seleziona Posizione</h3>
            <div id="archive-select-info" class="hidden mb-2 p-2 rounded text-xs border"></div>
            <div id="archive-select-tree" class="flex-1 border rounded p-2 overflow-y-auto bg-slate-50"></div>
            <div class="mt-4 flex justify-end gap-2"><button onclick="document.getElementById('modal-archive-select').classList.add('hidden')" class="px-4 py-2 border rounded">Annulla</button><button id="btn-confirm-archive" disabled class="px-4 py-2 bg-green-600 text-white rounded disabled:opacity-50">Conferma</button></div>
        </div>
    </div>
    <div id="toast-container" class="fixed bottom-4 right-4 z-50 flex flex-col gap-2"></div>

    <!-- Single Module Script for Everything -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, addDoc, onSnapshot, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CONFIGURAZIONE FIREBASE (DA COMPILARE) ---
        // 1. Vai su https://console.firebase.google.com/
        // 2. Crea un progetto, aggiungi una Web App
        // 3. Copia l'oggetto firebaseConfig qui sotto:
        // 4. Assicurati di abilitare "Anonymous Auth" e "Firestore Database" in modalità Test
        const firebaseConfig = {
			apiKey: "AIzaSyCeSKf5EV-Hc4yhWy_MRcAwZVGt2oEDbYE",
			authDomain: "gmparchive-80a71.firebaseapp.com",
			projectId: "gmparchive-80a71",
			storageBucket: "gmparchive-80a71.firebasestorage.app",
			messagingSenderId: "883733851688",
			appId: "1:883733851688:web:1a2e31872294bf13b70f1d",
			measurementId: "G-WLWZ8DH30P"
        };
        
        // Path Principale Database (3 SEGMENTI per evitare errori di "Invalid Collection Reference")
        // gmp_v2 (Coll) -> public_demo (Doc) -> [NomeCollezione] (Coll)
        const DB_PATH = ['gmp_v2', 'public_demo'];
        
        // Init Firebase
        let auth, db;
        
        if (firebaseConfig.apiKey !== "INSERISCI_API_KEY_QUI") {
            try {
                const fbApp = initializeApp(firebaseConfig);
                auth = getAuth(fbApp);
                db = getFirestore(fbApp);
            } catch (e) {
                console.error("Firebase Init Error:", e);
                alert("Errore inizializzazione Firebase: " + e.message);
            }
        } else {
            console.error("Firebase Config Mancante! Compila la sezione nello script.");
        }

        const SEED_DATA = {
            users: [
                { id: 'ADMIN', name: 'System Administrator', role: 'Amministratore', pass: 'password123', status: 'Attivo' },
                { id: 'SUP', name: 'Mario Rossi', role: 'Supervisore', pass: 'password123', status: 'Attivo' },
                { id: 'OP', name: 'Luca Bianchi', role: 'Operatore', pass: 'password123', status: 'Attivo' },
                { id: 'READ', name: 'Anna Verdi', role: 'Read Only', pass: 'password123', status: 'Attivo' }
            ],
            products: [
                { id: 'PROD-001', name: 'Paracetamolo 500mg', code: 'PCM500', desc: 'Compresse' },
                { id: 'PROD-002', name: 'Ibuprofene 200mg', code: 'IBU200', desc: 'Sciroppo' }
            ],
            archives: [
                { id: 'ARCH-01', name: 'Archivio GMP Centrale' },
                { id: 'ARCH-VAL', name: 'Archivio BR Validazione' }
            ],
            cupboards: [
                { id: 'ARM-A', name: 'Armadio A (Solidi)', parentId: 'ARCH-01' },
                { id: 'ARM-B', name: 'Armadio B (Liquidi)', parentId: 'ARCH-01' },
                { id: 'ARM-VAL-1', name: 'Armadio Val 1', parentId: 'ARCH-VAL' }
            ],
            shelves: [
                { id: 'SCAFF-A1', name: 'Scaffale A1', parentId: 'ARM-A' },
                { id: 'SCAFF-VAL-1A', name: 'Scaffale Val 1A', parentId: 'ARM-VAL-1' }
            ],
            binders: [
                { id: 'FALD-2025-001', code: '2025-001', parentId: 'SCAFF-A1', status: 'Disponibile' },
                { id: 'FALD-VAL-001', code: 'VAL-2025-01', parentId: 'SCAFF-VAL-1A', status: 'Disponibile' }
            ],
            systemSettings: [
                { id: 'security', minLength: 8, requireNumber: true, requireSpecial: true, requireUpper: true, expiryDays: 90, maxAttempts: 3 }
            ]
        };

        window.app = {
            db: { users:[], products:[], archives:[], cupboards:[], shelves:[], binders:[], batchRecords:[], loans:[], auditTrail:[], systemSettings: [] },
            currentUser: null,
            listeners: [],
            
            init: async () => {
                app.renderTime();
                setInterval(app.renderTime, 1000);
                
                if(!auth) {
                    document.getElementById('loading-text').textContent = "Errore Configurazione Firebase. Vedi Console.";
                    return;
                }

                document.getElementById('loading-text').textContent = "Autenticazione...";

                setTimeout(() => {
                    const overlay = document.getElementById('loading-overlay');
                    if(!overlay.classList.contains('fade-out') && !overlay.classList.contains('hidden')) {
                        console.warn("Forcing app start due to timeout");
                        app.checkCompletion(true);
                    }
                }, 7000);

                try {
                    await signInAnonymously(auth);
                } catch(e) {
                    console.error("Auth Failed", e);
                    document.getElementById('loading-text').textContent = "Errore Auth: " + e.message;
                    document.getElementById('config-error-msg').classList.remove('hidden');
                    document.getElementById('config-error-detail').textContent = e.code || e.message;
                    return;
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        document.getElementById('loading-text').textContent = "Sincronizzazione Dati...";
                        app.startSync(user);
                    }
                });

                document.getElementById('login-form').addEventListener('submit', app.handleLogin);
                document.getElementById('force-change-form').addEventListener('submit', app.handleForcePasswordChange);
                document.getElementById('security-settings-form').addEventListener('submit', app.handleSaveSecuritySettings);
                document.getElementById('esig-form').addEventListener('submit', app.handleESig);
                document.getElementById('dual-esig-form').addEventListener('submit', app.handleDualESig);
                document.getElementById('create-br-form').addEventListener('submit', app.handleCreateBR);
                document.getElementById('create-user-form').addEventListener('submit', app.handleCreateUser);
                document.getElementById('create-product-form').addEventListener('submit', app.handleCreateProduct);
                document.getElementById('add-archive-form').addEventListener('submit', app.handleAddArchive);
                document.getElementById('br-search').addEventListener('input', app.renderBatchRecords);
                document.getElementById('br-filter-status').addEventListener('change', app.renderBatchRecords);
            },

            startSync: (user) => {
                if (!user) return;
                
                app.listeners.forEach(u => u());
                app.listeners = [];

                const collections = ['users', 'products', 'archives', 'cupboards', 'shelves', 'binders', 'batchRecords', 'loans', 'auditTrail', 'systemSettings'];
                app.loadedCount = 0;
                app.totalCollections = collections.length;

                collections.forEach(colName => {
                    // FIX CRITICO: Uso DB_PATH per garantire struttura a 3 segmenti (Coll/Doc/Coll)
                    const colRef = collection(db,